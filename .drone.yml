---
kind: pipeline
type: exec
name: flake info

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:
  - name: show flake show
    commands:
      - nix flake show

  - name: show flake info
    commands:
      - nix flake info

  - name: run flake checks
    commands:
      - nix flake check

trigger:
  branch:
    - main
  event:
    - push
    - cron
    - pull_request

---
kind: pipeline
type: exec
name: build amd64 hosts

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:
  - name: login into attic
    commands:
      - nix run 'github:zhaofengli/attic' -- login lounge-rocks https://cache.lounge.rocks $ATTIC_KEY --set-default
    environment:
      ATTIC_KEY:
        from_secret: attic_key

  - name: build desktop
    commands:
      - nix build --print-out-paths '.#nixosConfigurations.desktop.config.system.build.toplevel'
      - nix run 'github:zhaofengli/attic' -- push nix-cache result
      - nix path-info --closure-size -h $(readlink -f result)

  - name: build flap
    commands:
      - nix build --print-out-paths '.#nixosConfigurations.flap.config.system.build.toplevel'
      - nix run 'github:zhaofengli/attic' -- push nix-cache result
      - nix path-info --closure-size -h $(readlink -f result)

  - name: build mobi
    commands:
      - nix build --print-out-paths '.#nixosConfigurations.mobi.config.system.build.toplevel'
      - nix run 'github:zhaofengli/attic' -- push nix-cache result
      - nix path-info --closure-size -h $(readlink -f result)

  - name: build rick
    commands:
      - nix build --print-out-paths '.#nixosConfigurations.rick.config.system.build.toplevel'
      - nix run 'github:zhaofengli/attic' -- push nix-cache result
      - nix path-info --closure-size -h $(readlink -f result)

trigger:
  branch:
    - main
  event:
    - cron
    - push
