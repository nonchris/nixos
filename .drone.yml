---
kind: pipeline
type: exec
name: flake info

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:

- name: show flake info
  commands:
  - nix --experimental-features "nix-command flakes" flake show
  - nix --experimental-features "nix-command flakes" flake metadata

- name: run flake checks
  commands:
  - nix --experimental-features "nix-command flakes" flake check --show-trace

---
kind: pipeline
type: exec
name: build desktop

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:

- name: build desktop
  commands:
  - nix build -v '.#nixosConfigurations.desktop.config.system.build.toplevel'

- name: show closure size
  commands:
  - nix path-info --closure-size -h $(readlink -f result)

- name: upload desktop to binary cache via s3
  commands:
  - nix copy --to 's3://nix-cache?scheme=https&region=eu-central-1&endpoint=s3.lounge.rocks' $(nix-store -qR result/) -L
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret

trigger:
  branch:
  - main
  - update-flake
  event:
  - cron
  - push
  - pull_request

---
kind: pipeline
type: exec
name: build flap

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:

- name: build flap
  commands:
  - nix build -v '.#nixosConfigurations.flap.config.system.build.toplevel'

- name: show closure size
  commands:
  - nix path-info --closure-size -h $(readlink -f result)

- name: upload flap to binary cache via s3
  commands:
  - nix copy --to 's3://nix-cache?scheme=https&region=eu-central-1&endpoint=s3.lounge.rocks' $(nix-store -qR result/) -L
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret

trigger:
  branch:
  - main
  - update-flake
  event:
  - cron
  - push
  - pull_request

---
kind: pipeline
type: exec
name: build mobi

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:

- name: build mobi
  commands:
  - nix build -v '.#nixosConfigurations.mobi.config.system.build.toplevel'

- name: show closure size
  commands:
  - nix path-info --closure-size -h $(readlink -f result)

- name: upload mobi to binary cache via s3
  commands:
  - nix copy --to 's3://nix-cache?scheme=https&region=eu-central-1&endpoint=s3.lounge.rocks' $(nix-store -qR result/) -L
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret

trigger:
  branch:
  - main
  - update-flake
  event:
  - cron
  - push
  - pull_request

---
kind: pipeline
type: exec
name: build rick

platform:
  os: linux
  arch: amd64

clone:
  depth: 1

steps:

- name: build rick
  commands:
  - nix build -v '.#nixosConfigurations.rick.config.system.build.toplevel'

- name: show closure size
  commands:
  - nix path-info --closure-size -h $(readlink -f result)

- name: upload rick to binary cache via s3
  commands:
  - nix copy --to 's3://nix-cache?scheme=https&region=eu-central-1&endpoint=s3.lounge.rocks' $(nix-store -qR result/) -L
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_key
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret

trigger:
  branch:
  - main
  - update-flake
  event:
  - cron
  - push
  - pull_request
